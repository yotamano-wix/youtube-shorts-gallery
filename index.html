<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Infinite Scrolling Carousel</title>
  <style>
    /* Remove default body margin */
    body {
      margin: 0;
    }

    /* Full Width and Fixed Height */
    .carousel-container {
      display: flex;
      overflow: hidden;
      width: 100%;
      height: 800px;
      position: relative;
    }

    /* Wrapper for videos */
    .carousel-wrapper {
      display: flex;
    }

    /* Each video container */
    .video-container {
      position: relative;
      width: calc((9 / 16) * 800px); /* Dynamic width based on 9:16 aspect ratio */
      height: 100%; /* Full height of 800px container */
      margin-right: 4px; /* 4px margin between videos */
      box-sizing: border-box;
      padding: 0;
      flex-shrink: 0;
    }

    /* Iframe Styling */
    iframe {
      width: 100%;
      height: 100%;
      border: none;
      padding: 0; /* Ensure no padding within the iframe */
      overflow: hidden; /* Prevents inner scroll */
    }
  </style>
</head>
<body>
  <div class="carousel-container" id="carouselContainer">
    <div class="carousel-wrapper" id="videoGallery"></div>
  </div>

  <!-- Load YouTube Iframe API -->
  <script src="https://www.youtube.com/iframe_api"></script>

  <script>
    const players = [];
    let activePlayer = null; // Track the currently active (hovered) player
    let scrollSpeed = 1; // Pixels per tick
    let currentScroll = 0; // Track current scroll position
    let scrollInterval;

    // Function to wait for the YouTube Iframe API to load
    function loadYouTubeIframeAPI() {
      return new Promise(resolve => {
        if (window.YT && window.YT.Player) {
          resolve();
        } else {
          window.onYouTubeIframeAPIReady = resolve;
        }
      });
    }

    // Function to fetch video IDs from the URL parameters
    function getVideoParams() {
      const urlParams = new URLSearchParams(window.location.search);
      const videos = [];
      for (const [key, value] of urlParams.entries()) {
        if (key.startsWith('video')) {
          videos.push(value);
        }
      }
      return videos;
    }

    // Initialize the carousel after ensuring API and videos are fully loaded
    async function initializeCarousel() {
      await loadYouTubeIframeAPI();
      const videos = getVideoParams();

      // Ensure videos are loaded in gallery
      const loaded = await loadVideosIntoGallery(videos);
      if (loaded) {
        startScrolling(document.getElementById('videoGallery'), videos.length);
      } else {
        console.error("Videos failed to load.");
      }
    }

    // Load videos into gallery and wait for all iframes to be ready
    async function loadVideosIntoGallery(videos) {
      const gallery = document.getElementById('videoGallery');
      gallery.innerHTML = ''; // Clear any existing content

      const loadPromises = [
        ...videos.map((videoId, index) => addVideoToGallery(gallery, videoId, index)),
        ...videos.map((videoId, index) => addVideoToGallery(gallery, videoId, index + videos.length))
      ];

      // Wait for all iframes to load successfully
      const loadedFrames = await Promise.all(loadPromises);
      return loadedFrames.every(Boolean);
    }

    // Add each video to the gallery and return a promise that resolves when the iframe loads
    function addVideoToGallery(gallery, videoId, index) {
      return new Promise(resolve => {
        const videoContainer = document.createElement('div');
        videoContainer.classList.add('video-container');
        
        const iframe = document.createElement('iframe');
        iframe.setAttribute('id', `player-${index}`);
        iframe.src = `https://www.youtube.com/embed/${videoId}?enablejsapi=1&autoplay=1&mute=1&loop=1&playlist=${videoId}&controls=0&showinfo=0&modestbranding=1&origin=${window.location.origin}`;
        iframe.allow = "autoplay";
        iframe.width = '100%';
        iframe.height = '100%';

        // Load player when iframe loads
        iframe.onload = () => {
          const player = new YT.Player(iframe, {
            events: {
              'onReady': function (event) {
                event.target.mute(); // Start muted
              }
            }
          });

          players.push(player);
          videoContainer.addEventListener("mouseover", () => handleMouseOver(player));
          videoContainer.addEventListener("mouseleave", handleMouseLeave);

          resolve(true); // Resolve as successful once player is initialized
        };

        // Handle load failure
        iframe.onerror = () => resolve(false);

        videoContainer.appendChild(iframe);
        gallery.appendChild(videoContainer);
      });
    }

    function handleMouseOver(player) {
      if (activePlayer && activePlayer !== player) {
        activePlayer.mute(); // Mute the previously active player
      }
      player.unMute();
      activePlayer = player; // Set this player as the currently active one
    }

    function handleMouseLeave() {
      if (activePlayer) {
        activePlayer.mute();
      }
    }

    // Start scrolling once all videos are loaded
    function startScrolling(gallery, videoCount) {
      const videoWidth = gallery.firstChild.offsetWidth + 4; // Width of one video + margin
      const totalScrollWidth = videoWidth * videoCount; // Width of the original set

      scrollInterval = setInterval(() => {
        currentScroll += scrollSpeed;
        gallery.style.transform = `translateX(-${currentScroll}px)`;

        // Reset scroll position for seamless looping
        if (currentScroll >= totalScrollWidth) {
          currentScroll = 0;
          gallery.style.transform = `translateX(0)`;
        }
      }, 20); // Adjust the interval for smoother effect
    }

    // Pause scrolling when hovering over the carousel container
    const carouselContainer = document.getElementById('carouselContainer');
    carouselContainer.addEventListener("mouseover", () => clearInterval(scrollInterval));
    carouselContainer.addEventListener("mouseleave", () => {
      const gallery = document.getElementById('videoGallery');
      startScrolling(gallery, getVideoParams().length);
    });

    // Stop scrolling and mute all videos when the page loses focus
    window.addEventListener('blur', () => {
      clearInterval(scrollInterval);
      players.forEach(player => player.mute());
    });

    // Restart scrolling and unmute active video (if any) when the page regains focus
    window.addEventListener('focus', () => {
      const gallery = document.getElementById('videoGallery');
      startScrolling(gallery, getVideoParams().length);
      if (activePlayer) {
        activePlayer.unMute();
      }
    });

    // Initialize the carousel on page load
    initializeCarousel();
  </script>
</body>
</html>
